- name: Lancement playbook haproxy backend
  hosts: "{{ haproxy_back_ansible_hostsgroup }}"
  gather_facts: yes
  vars_files: nextcloud_vars.yml



  tasks:
    - include_vars: nextcloud_vars.yml

    - name: Update repositories cache and install "haproxy" package
      apt:
       name: haproxy
       update_cache: yes    
    
    - name: cat conf haproxy.cfg
      shell: |
        cat << EOF > /etc/haproxy/haproxy.cfg
        global
          log /dev/log	local0
          log /dev/log	local1 notice
          chroot /var/lib/haproxy
          stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
          stats timeout 30s
          user haproxy
          group haproxy
          daemon

          # Default SSL material locations
          ca-base /etc/ssl/certs
          crt-base /etc/ssl/private

          # Default ciphers to use on SSL-enabled listening sockets.
          # For more information, see ciphers(1SSL). This list is from:
          #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
          # An alternative list with additional directives can be obtained from
          #  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy
          ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
          ssl-default-bind-options no-sslv3

        defaults
          log	global
          mode	http
          option	dontlognull
                timeout connect 5000
                timeout client  50000
                timeout server  50000
          errorfile 400 /etc/haproxy/errors/400.http
          errorfile 403 /etc/haproxy/errors/403.http
          errorfile 408 /etc/haproxy/errors/408.http
          errorfile 500 /etc/haproxy/errors/500.http
          errorfile 502 /etc/haproxy/errors/502.http
          errorfile 503 /etc/haproxy/errors/503.http
          errorfile 504 /etc/haproxy/errors/504.http

        listen rabbitmq
                bind *:5672
                mode tcp
                option clitcpka
                balance roundrobin
                server rabbit-1 192.168.40.41:5672 check inter 5s rise 2 fall 3
                server rabbit-2 192.168.40.42:5672 check inter 5s rise 2 fall 3
                server rabbit-3 192.168.40.43:5672 check inter 5s rise 2 fall 3

        listen redis
                bind *:6379
                mode            tcp
                timeout connect     30000
                timeout server      30000
                retries         3
                option tcp-check
                tcp-check connect
                tcp-check send PING\r\n
                tcp-check expect string +PONG
                tcp-check send QUIT\r\n
                tcp-check expect string +OK
                server          redis1 {{ redis1_ip }}:{{ redis1_port }}       check inter 1000  maxconn 1024
                server          redis2 {{ redis2_ip }}:{{ redis2_port }} backup check inter 1000  maxconn 1024

        listen postgresql
                bind *:5432
                mode tcp
                option pgsql-check user primaryuser
                default-server inter 3s fall 3
                server   postgresql1 {{ pgsql_master_ip }}:5432        check port 5432
                server   postgresql2 {{ pgsql_slave_ip }}:5432 backup  port 5432


        EOF
      args:
       executable: /bin/bash    

    - name: Restart service haproxy
      service:
       name: haproxy
       state: restarted